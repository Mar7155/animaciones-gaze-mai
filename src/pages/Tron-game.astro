---
import Layout from "../layouts/Layout.astro";
---

<Layout>    
    <section>
        <a-scene loading-screen="enabled:false" background="color: #050505" renderer="colorManagement: true; antialias: true;">

        <a-assets>
            <a-asset-item id="modelo-moto" src="/assets/Tron-game/tron_moto_sdc__free.glb"></a-asset-item>
            <a-asset-item id="modelo-moto_2" src="/assets/Tron-game/tron_moto_-_low_poly_-_sdc_-_free.glb"></a-asset-item>
            <a-asset-item id="bit" src="/assets/Tron-game/tron_1982_bit.glb"></a-asset-item>
            <a-asset-item id="recognizer" src="/assets/Tron-game/tron.glb"></a-asset-item>
            <a-asset-item id="edificios" src="/assets/Tron-game/edificios.glb"></a-asset-item>
            <a-asset-item id="tron-logo" src="/assets/Tron-game/tron_legacy-era_neon_logo.glb"></a-asset-item>
        </a-assets>

        <a-entity id="ui-score" position="0 55 10" rotation="-55 0 0">
            <a-entity id="text-p1" text="value: P1: 0; color: #00ffff; align: center; width: 30; font: monoid" position="-15 0 0"></a-entity>
            <a-entity id="text-p2" text="value: P2: 0; color: #ff6600; align: center; width: 30; font: monoid" position="15 0 0"></a-entity>
        </a-entity>

        <a-entity id="start-menu" position="0 25 20" rotation="-30 0 0">
                animation="property: position; to: 0 5.5 0; dir: alternate; loop: true; dur: 2000; easing: easeInOutSine">
            </a-entity>
            <a-entity id="start-text" text="value: ESPERANDO JUGADOR...; align: center; width: 40; color: #7DFDFE; font: monoid" position="0 0 0"></a-entity>
            <a-entity id="p1-ready" text="value: P1: NO LISTO; color: red; align: center; width: 20; font: monoid" position="-10 -5 0"></a-entity>
            <a-entity id="p2-ready" text="value: P2: NO LISTO; color: red; align: center; width: 20; font: monoid" position="10 -5 0"></a-entity>
            <a-light type="point" color="#00ffff" intensity="2" distance="20"></a-light>
        </a-entity>

        <a-entity position="0 65 50" rotation="-55 0 0">
            <a-camera look-controls="enabled: false" wasd-controls="enabled: false"></a-camera>
        </a-entity>

        <a-plane position="0 0 0" rotation="-90 0 0" width="200" height="200" color="#000000"></a-plane>
        <a-plane position="0 0.1 0" rotation="-90 0 0" width="200" height="200" 
                color="#66b4ce" material="wireframe: true; opacity: 0.4" 
                segments-width="80" segments-height="80"></a-plane>

        <a-entity id="bit-entity" visible="false" position="0 5 0" animation="property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear">
            <a-entity gltf-model="#bit" scale="0.0005 0.0005 0.0005" rotation="0 180 0"></a-entity>
        </a-entity>

        <a-entity id="arena-walls">
            <a-box class="wall" position="-40 1 0" width="0.5" height="2" depth="80" color="#141414" material="emissive: #3D3D3D; emissiveIntensity: 0.5"></a-box>
            <a-box class="wall" position="40 1 0" width="0.5" height="2" depth="80" color="#141414" material="emissive: #3D3D3D; emissiveIntensity: 0.5"></a-box>
            <a-box class="wall" position="0 1 -40" width="80" height="2" depth="0.5" color="#141414" material="emissive: #3D3D3D; emissiveIntensity: 0.5"></a-box>
            <a-box class="wall" position="0 1 40" width="80" height="2" depth="0.5" color="#141414" material="emissive: #3D3D3D; emissiveIntensity: 0.5"></a-box>
        </a-entity>

        <a-entity id="local-moto" player-movement="color:#00ffff; startX:-10; startZ:30" multiplayer-sync>
            <a-entity gltf-model="#modelo-moto" scale="0.005 0.005 0.005" rotation="0 180 0"></a-entity>
            <a-light type="point" color="#d6f1f3" intensity="2" distance="15" decay="1.5" position="0 1 0"></a-light>
        </a-entity>

        </a-scene>
    </section>

  <script is:inline type="module">
  import { api } from "../../convex/_generated/api";
  import { client } from "../../src/lib/convex-client.ts";

  // --- CONFIGURACIÓN DE SALA ---
  const params = new URLSearchParams(window.location.search);
  const myPlayerId = params.get('player'); 
  const currentRoomId = params.get('room'); 

  if (!myPlayerId || !currentRoomId) {
      alert("Error: Falta información de la sala. Redirigiendo...");
      window.location.href = '/waiting-room';
  }

  const ARENA_LIMIT = 39.5;
  const TRAIL_STEP = 0.5; 
  const localTrails = [];
  const renderedTrails = new Set();
  
  let currentRound = 1;

  // --- COMPONENTE MULTIPLAYER SYNC ---
  AFRAME.registerComponent('multiplayer-sync', {
    tick: function() {
      if (!window.gameStarted || this.el.components['player-movement'].dead) return; 

      const pos = this.el.object3D.position;
      const rot = this.el.object3D.rotation.y;

      if (currentRoomId) {
        client.mutation(api.players.updatePosition, {
          roomId: currentRoomId,
          playerId: myPlayerId,
          playerName: "Player", // TODO: Pasar nombre real
          isHost: false, // Se ignora en update
          x: pos.x,
          z: pos.z,
          angle: rot
        });
      }
    }
  });

  // --- ESCUCHA DE DATOS DE LA SALA ---
  client.onUpdate(api.rooms.get, { roomId: currentRoomId }, (room) => {
      if (!room) return;

      // 1. Actualizar UI de Estado (Waiting/Ready)
      const startText = document.querySelector('#start-text');
      const p1Text = document.querySelector('#p1-ready');
      const p2Text = document.querySelector('#p2-ready');
      const menu = document.querySelector('#start-menu');

      if (room.status === "waiting") {
          let msg = "ESPERANDO JUGADOR...";
          if (room.hostId && room.guestId) msg = "PRESIONA ENTER PARA LISTO";
          startText.setAttribute('text', `value: ${msg}`);

          p1Text.setAttribute('text', `value: P1: ${room.p1Ready ? 'LISTO' : '...'}; color: ${room.p1Ready ? '#00ff00' : 'red'}`);
          p2Text.setAttribute('text', `value: P2: ${room.guestId ? (room.p2Ready ? 'LISTO' : '...') : 'ESPERANDO'}; color: ${room.p2Ready ? '#00ff00' : 'red'}`);
          
          menu.setAttribute('visible', 'true');
          window.gameStarted = false;
      } else if (room.status === "playing") {
          menu.setAttribute('visible', 'false');
          if (!window.gameStarted) {
              window.gameStarted = true;
              spawnBit();
          }
      } else if (room.status === "ended") {
          window.gameStarted = false;
          menu.setAttribute('visible', 'true');
          startText.setAttribute('text', `value: GAME OVER! GANADOR: ${room.winner.toUpperCase()}`);
          setTimeout(() => window.location.href = '/waiting-room', 5000);
      }

      // 2. Actualizar Scores
      if (room.scores) {
          document.querySelector('#text-p1').setAttribute('text', `value: P1: ${room.scores.p1}`);
          document.querySelector('#text-p2').setAttribute('text', `value: P2: ${room.scores.p2}`);
      }

      // 3. Detectar cambio de ronda
      if (room.currentRound > currentRound) {
          currentRound = room.currentRound;
          resetLocalPlayer(room);
          clearLocalTrails();
      }
  });

  function resetLocalPlayer(room) {
      const playerEl = document.querySelector('#local-moto');
      const isHost = myPlayerId === room.hostId;
      const startX = isHost ? -10 : 10;
      
      playerEl.components['player-movement'].dead = false;
      playerEl.components['player-movement'].reset(startX, 30);
  }

  function clearLocalTrails() {
      // Eliminar visualmente las estelas
      const scene = document.querySelector('a-scene');
      document.querySelectorAll('.trail-segment').forEach(el => el.parentNode.removeChild(el));
      renderedTrails.clear();
      localTrails.length = 0;
  }

  function spawnBit() {
      const bit = document.querySelector('#bit-entity');
      bit.setAttribute('visible', 'true');
      bit.setAttribute('animation__spawn', 'property: scale; from: 0 0 0; to: 1 1 1; dur: 800; easing: easeOutElastic');
  }

  // --- ESCUCHA DE JUGADORES Y ESTELAS ---
  if (currentRoomId) {
    client.onUpdate(api.players.getPlayersInRoom, { roomId: currentRoomId }, (players) => {
      players.forEach(p => {
        if (p.playerId !== myPlayerId) {
          let rivalEl = document.querySelector(`#rival-${p.playerId}`);
          if (!rivalEl) rivalEl = crearRivalVisual(p);
          
          rivalEl.setAttribute('visible', !p.isDead);
          rivalEl.object3D.position.set(p.x, 0, p.z);
          rivalEl.object3D.rotation.y = p.angle;
        }
      });
    });

    client.onUpdate(api.trails.getTrails, { roomId: currentRoomId }, (trails) => {
      const scene = document.querySelector('a-scene');
      
      // Si la lista de trails está vacía en el servidor, limpiar localmente (reseteo de ronda)
      if (trails.length === 0 && renderedTrails.size > 0) {
          clearLocalTrails();
          return;
      }

      trails.forEach(t => {
        const key = `${t.x.toFixed(1)}-${t.z.toFixed(1)}`;
        if (!renderedTrails.has(key)) {
          const seg = document.createElement('a-box');
          seg.setAttribute('position', `${t.x} 0.6 ${t.z}`);
          seg.setAttribute('width', 0.6); seg.setAttribute('height', 1.2); seg.setAttribute('depth', 0.6);
          seg.setAttribute('material', `color: ${t.color}; emissive: ${t.color}; opacity: 0.6; transparent: true`);
          seg.setAttribute('class', 'wall trail-segment'); 
          scene.appendChild(seg);
          renderedTrails.add(key);
          localTrails.push(t);
        }
      });
    });
  }

  // --- LÓGICA DE MOVIMIENTO ---
  AFRAME.registerComponent('player-movement', {
    schema: { color: {type: 'color'}, startX: {type: 'number'}, startZ: {type: 'number'} },
    init() {
      this.dir = new THREE.Vector3(0, 0, -1);
      this.heading = 'up';
      this.speed = 18;
      this.lastTrailPos = new THREE.Vector3();
      this.dead = false;
      this.reset(this.data.startX, this.data.startZ);

      window.addEventListener('keydown', (e) => {
        if (this.dead || !window.gameStarted) return;
        const key = e.key.toLowerCase();
        if ((key === 'w' || key === 'arrowup') && this.heading !== 'down') this.setDir(0,0,-1,'up',0);
        else if ((key === 's' || key === 'arrowdown') && this.heading !== 'up') this.setDir(0,0,1,'down',Math.PI);
        else if ((key === 'a' || key === 'arrowleft') && this.heading !== 'right') this.setDir(-1,0,0,'left',Math.PI/2);
        else if ((key === 'd' || key === 'arrowright') && this.heading !== 'left') this.setDir(1,0,0,'right',-Math.PI/2);
      });
    },
    reset(x, z) {
        this.el.object3D.position.set(x, 0, z);
        this.setDir(0,0,-1,'up',0); // Reset dirección
        this.lastTrailPos.copy(this.el.object3D.position);
    },
    setDir(x,y,z,h,rot) { this.dir.set(x,y,z); this.heading = h; this.el.object3D.rotation.y = rot; },
    tick(time, delta) {
      if (!window.gameStarted || this.dead) return;
      const step = this.speed * delta / 1000;
      const pos = this.el.object3D.position;
      pos.addScaledVector(this.dir, step);

      if (Math.abs(pos.x) > ARENA_LIMIT || Math.abs(pos.z) > ARENA_LIMIT) return this.die();

      if (pos.distanceTo(this.lastTrailPos) >= TRAIL_STEP) {
        if (currentRoomId) {
          client.mutation(api.trails.addSegment, {
            roomId: currentRoomId, x: pos.x, z: pos.z, ownerId: myPlayerId, color: this.data.color
          });
        }
        this.lastTrailPos.copy(pos);
      }
      this.checkCollisions(pos);
    },
    checkCollisions(pos) {
      for (let t of localTrails) {
        const dist = Math.sqrt(Math.pow(pos.x - t.x, 2) + Math.pow(pos.z - t.z, 2));
        if (dist < 0.4) {
          // No morir con tu propia estela reciente
          if (t.ownerId === myPlayerId && localTrails.indexOf(t) > localTrails.length - 5) continue;
          this.die();
        }
      }
    },
    die() {
      if (this.dead) return;
      this.dead = true;
      const boom = document.createElement('a-entity');
      boom.setAttribute('geometry', 'primitive: sphere; radius: 0.5');
      boom.setAttribute('material', 'color: red; emissive: red; emissiveIntensity: 5');
      boom.setAttribute('animation', 'property: scale; to: 10 10 10; dur: 300');
      boom.object3D.position.copy(this.el.object3D.position);
      document.querySelector('a-scene').appendChild(boom);
      
      // Notificar muerte al servidor
      client.mutation(api.players.notifyDeath, { roomId: currentRoomId, playerId: myPlayerId });
    }
  });

  // --- AUXILIARES ---
  function crearRivalVisual(p) {
    const el = document.createElement('a-entity');
    el.setAttribute('id', `rival-${p.playerId}`);
    el.setAttribute('gltf-model', '#modelo-moto_2');
    el.setAttribute('scale', '0.4 0.4 0.4');
    document.querySelector('a-scene').appendChild(el);
    return el;
  }

  // --- INPUT PARA LISTO ---
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !window.gameStarted) {
        client.mutation(api.rooms.setReady, { roomId: currentRoomId, playerId: myPlayerId });
    }
  });
  </script>
</Layout>
</Layout>